<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>Kurýrní aplikace v7.3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: sans-serif; margin: 0; }
    #camera-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 9999; flex-direction: column; justify-content: center; align-items: center; }
    video { width: 100%; height: 80%; object-fit: cover; }
    #scan-btn { font-size: 24px; padding: 16px 32px; margin-top: 20px; background: #007bff; color: white; border: none; border-radius: 8px; }
    #map { height: 300px; border-bottom: 1px solid #ccc; }
    #camera-btn { display: block; width: 100%; font-size: 20px; padding: 16px 0; background: #007bff; color: white; border: none; }
    .address { margin: 5px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; background: #f9f9f9; cursor: pointer; }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <div id="map"></div>
  <button id="camera-btn">📸 Naskenovat adresu</button>
  <div id="addresses"></div>

  <div id="camera-overlay">
    <video id="video" autoplay playsinline></video>
    <button id="scan-btn">📸 Naskenovat nyní</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
  <script>
    let map = L.map('map').setView([50.08, 14.44], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    let addresses = JSON.parse(localStorage.getItem("addresses") || "[]");
    let markers = [];
    let stream = null;

    function addMarker(lat, lng, text) {
      const marker = L.marker([lat, lng]).addTo(map).bindPopup(text);
      markers.push(marker);
    }

    function renderAddresses() {
      document.getElementById("addresses").innerHTML = "";
      addresses.forEach((item, idx) => {
        const div = document.createElement("div");
        div.className = "address";
        div.textContent = item.text;
        div.onclick = () => {
          map.setView([item.lat, item.lng], 15);
          markers[idx].openPopup();
        };
        document.getElementById("addresses").appendChild(div);
      });
    }

    function geocode(address) {
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
        .then(response => response.json())
        .then(data => {
          if (data && data[0]) {
            const lat = parseFloat(data[0].lat);
            const lng = parseFloat(data[0].lon);
            addMarker(lat, lng, address);
            addresses.push({ text: address, lat, lng });
            localStorage.setItem("addresses", JSON.stringify(addresses));
            renderAddresses();
          } else {
            alert("Nepodařilo se najít souřadnice.");
          }
          closeCamera();
        }).catch(() => closeCamera());
    }

    async function startCamera() {
      let overlay = document.getElementById("camera-overlay");
      overlay.style.display = "flex";
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: "environment" } } });
      let video = document.getElementById("video");
      video.srcObject = stream;
      await video.play();
    }

    async function scanOCR() {
      let video = document.getElementById("video");
      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0);
      const { data: { text } } = await Tesseract.recognize(canvas, 'ces');

      const clean = text.replace(/[^A-Za-z0-9á-žÁ-Ž\s\/\-]/g, '').trim();
      if (!clean) { alert("❌ Nenalezena adresa."); closeCamera(); return; }
      if (addresses.map(a => a.text.toLowerCase()).includes(clean.toLowerCase())) {
        alert("⚠️ Adresa již existuje."); closeCamera(); return;
      }
      geocode(clean);
      closeCamera();
    }

    function closeCamera() {
      let overlay = document.getElementById("camera-overlay");
      overlay.style.display = "none";
      if (stream && stream.getTracks) {
        stream.getTracks().forEach(track => track.stop());
      }
    }

    document.getElementById("camera-btn").onclick = () => startCamera();
    document.getElementById("scan-btn").onclick = () => scanOCR();
    renderAddresses();
  </script>
</body>
</html>