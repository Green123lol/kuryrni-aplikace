<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>KurÃ½rnÃ­ aplikace v7.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: sans-serif; padding: 10px; }
    #map { height: 300px; border: 1px solid #ccc; border-radius: 8px; margin: 10px 0; }
    #camera-btn { font-size: 20px; padding: 16px 32px; margin: 10px 0; background-color: #007bff; color: white; border: none; border-radius: 8px; width: 100%; }
    #camera-btn[disabled] { background-color: #888; }
    .address { margin: 5px 0; padding: 5px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; background: #f9f9f9; }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <h1>ðŸ“¦ KurÃ½rnÃ­ aplikace (verze 7.0)</h1>
  <div id="map"></div>
  <button id="camera-btn">ðŸ“¸ Naskenovat adresu</button>
  <div id="addresses"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
  <script>
    let map = L.map('map').setView([50.08, 14.44], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);

    let addresses = JSON.parse(localStorage.getItem("addresses") || "[]");
    let markers = [];

    function addMarker(lat, lng, text) {
      const marker = L.marker([lat, lng]).addTo(map).bindPopup(text);
      markers.push(marker);
    }

    function renderAddresses() {
      document.getElementById("addresses").innerHTML = "";
      addresses.forEach((item, idx) => {
        const div = document.createElement("div");
        div.className = "address";
        div.textContent = item.text;
        div.onclick = () => {
          map.setView([item.lat, item.lng], 15);
          markers[idx].openPopup();
        };
        document.getElementById("addresses").appendChild(div);
      });
    }

    function geocode(address) {
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
        .then(response => response.json())
        .then(data => {
          if (data && data[0]) {
            const lat = parseFloat(data[0].lat);
            const lng = parseFloat(data[0].lon);
            addMarker(lat, lng, address);
            addresses.push({ text: address, lat, lng });
            localStorage.setItem("addresses", JSON.stringify(addresses));
            renderAddresses();
          } else {
            alert("NepodaÅ™ilo se najÃ­t souÅ™adnice.");
          }
        });
    }

    async function scanAddress() {
      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0);
      const { data: { text } } = await Tesseract.recognize(canvas, 'ces');

      const clean = text.replace(/[^A-Za-z0-9Ã¡-Å¾Ã-Å½\s\/\-]/g, '').trim();
      if (!clean) { alert("âŒ Nenalezena adresa."); return; }

      if (addresses.map(a => a.text.toLowerCase()).includes(clean.toLowerCase())) {
        alert("âš ï¸ Adresa jiÅ¾ existuje.");
        return;
      }

      geocode(clean);
    }

    document.getElementById("camera-btn").onclick = () => scanAddress();

    let video = document.createElement("video");
    video.setAttribute("playsinline", "");
    navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: "environment" } } })
      .then(stream => {
        video.srcObject = stream;
        video.play();
      });

    renderAddresses();
  </script>
</body>
</html>